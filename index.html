<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Nebula Photo Adventure</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:#000;touch-action:none;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  canvas{display:block}
  #ui{
    position:fixed;left:12px;top:12px;z-index:10;
    background:rgba(18,18,26,.62);backdrop-filter:blur(10px);
    border-radius:14px;padding:12px 12px;color:#fff;font-size:12px;line-height:1.25;
    max-width:min(340px,92vw)
  }
  #ui b{font-size:13px}
  #ui .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #ui button{
    background:#24242e;border:0;color:#fff;border-radius:10px;padding:8px 10px;font-size:12px
  }
  #ui button:active{transform:scale(.98)}
  #hud{
    position:fixed;left:12px;bottom:12px;z-index:10;
    color:#bbb;font-size:12px;opacity:.7;background:rgba(0,0,0,.35);
    padding:8px 10px;border-radius:12px;backdrop-filter:blur(10px)
  }
  #love{
    position:fixed;left:50%;top:60%;
    transform:translate(-50%,-50%);
    z-index:11;color:#fff;font-size:18px;text-align:center;
    padding:14px 16px;border-radius:18px;
    background:rgba(0,0,0,.45);backdrop-filter:blur(10px);
    max-width:min(560px,90vw);
    opacity:0;pointer-events:none;
    transition:opacity .25s ease;
    text-shadow:0 8px 22px rgba(0,0,0,.8);
  }
  #love small{display:block;font-size:12px;color:#ddd;opacity:.85;margin-top:6px}
</style>
</head>

<body>
<canvas id="c"></canvas>

<div id="ui">
  <b>üåå Nebula Photo Adventure (9:16)</b><br>
  ‚Ä¢ Drag = geser ‚Ä¢ Pinch/Scroll = zoom<br>
  ‚Ä¢ Klik foto = kamera ngikutin<br>
  ‚Ä¢ Hemat HP: render max <b>20 meteor</b><br>
  <div class="row">
    <button id="btnPlay">‚ñ∂ Play</button>
    <button id="btnPause">‚è∏ Pause</button>
    <button id="btnAuto">üß≠ Auto Tour: OFF</button>
    <button id="btnShuffle">üé≤ Shuffle</button>
  </div>
  <div class="row">
    <button id="btnRec">üé• Record: OFF</button>
    <button id="btnFS">‚õ∂ Fullscreen</button>
  </div>
</div>

<div id="love"></div>
<div id="hud">Loading...</div>

<audio id="music" src="music.mp3" loop></audio>

<script>
/* =========================
   CONFIG
========================= */
const TOTAL_PHOTO = 43;   // sesuaikan kalau nanti jadi 55
const MAX_RENDER  = 20;   // limit meteor aktif (anti-lag)
const MIN_R = 550;        // jarak minimum sebaran
const MAX_R = 1700;       // jarak maksimum sebaran (biar gak kejauhan)
const ORBIT_SPEED = 0.00055; // kecepatan orbit ringan
const TRAIL_LEN = 12;     // panjang jejak meteor (semakin besar semakin berat)
const TAP_RADIUS = 55;    // toleransi klik (screen px)

/* =========================
   CANVAS SETUP
========================= */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha: false });

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener('resize', resize);
resize();

/* =========================
   UI + AUDIO
========================= */
const hud = document.getElementById('hud');
const loveBox = document.getElementById('love');
const music = document.getElementById('music');

btnPlay.onclick  = () => music.play().catch(()=>{});
btnPause.onclick = () => music.pause();

let autoTour = false;
btnAuto.onclick = () => {
  autoTour = !autoTour;
  btnAuto.textContent = `üß≠ Auto Tour: ${autoTour ? 'ON' : 'OFF'}`;
  if(autoTour) followId = null;
};

btnShuffle.onclick = () => {
  // acak posisi meteor biar feel "petualangan baru"
  for(const m of meteors){
    const p = randRing(MIN_R, MAX_R);
    m.x = p.x; m.y = p.y;
    m.baseAngle = Math.random()*Math.PI*2;
    m.orbitR = Math.hypot(m.x,m.y);
    m.trail.length = 0;
  }
  followId = null;
};

btnFS.onclick = async () => {
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch(e){}
};

/* =========================
   CAMERA
========================= */
const cam = {
  x: 0,
  y: 0,
  zoom: 1.0,
  targetZoom: 1.0
};

// smoothing
function lerp(a,b,t){ return a + (b-a)*t; }

/* =========================
   METEORS (PHOTOS)
========================= */
function randRing(minR,maxR){
  // sebaran rata di area cincin (donut) biar gak dempet + gak terlalu jauh
  const t = Math.random();
  const r = Math.sqrt(t*(maxR*maxR - minR*minR) + minR*minR);
  const a = Math.random()*Math.PI*2;
  return { x: Math.cos(a)*r, y: Math.sin(a)*r };
}

const meteors = [];
let loadedCount = 0;

for(let i=1;i<=TOTAL_PHOTO;i++){
  const img = new Image();
  img.src = `fotos/${i}.jpg`;
  img.onload = () => loadedCount++;

  const p = randRing(MIN_R, MAX_R);
  meteors.push({
    id: i,
    img,
    x: p.x,
    y: p.y,
    size: 48 + Math.random()*54,         // ukuran dasar meteor
    orbitR: Math.hypot(p.x,p.y),
    baseAngle: Math.atan2(p.y,p.x),
    speed: (0.7 + Math.random()*0.8),    // variasi orbit
    trail: []                            // simpan posisi jejak
  });
}

/* =========================
   ROMANTIC TEXT (kamu bisa edit)
   Muncul kalau kamu zoom dekat meteor tertentu
========================= */
const loveLines = new Map([
  [1, "Aku nggak butuh semesta‚Ä¶ aku cuma butuh kamu. üåå‚ù§Ô∏è"],
  [2, "Kalau kamu capek, sini‚Äîaku peluk dari jauh. ü§ç"],
  [3, "Di antara jutaan bintang, kamu paling terang buat aku. ‚ú®"],
  [7, "Aku sayang kamu‚Ä¶ lebih dari kata-kata bisa jelasin. üòö"],
  [13,"Kamu rumah paling tenang yang pernah aku temuin. üè°"],
]);

/* =========================
   CLICK / TAP FOLLOW
========================= */
let followId = null;       // id meteor yang di-follow
let followStrength = 0.08; // smooth follow

function screenToWorld(sx,sy){
  const wx = (sx - canvas.width/2)/cam.zoom + cam.x;
  const wy = (sy - canvas.height/2)/cam.zoom + cam.y;
  return {wx,wy};
}

function worldToScreen(wx,wy){
  const sx = (wx - cam.x)*cam.zoom + canvas.width/2;
  const sy = (wy - cam.y)*cam.zoom + canvas.height/2;
  return {sx,sy};
}

function pickMeteorAtScreen(sx,sy){
  // pilih meteor terdekat dari posisi tap (berdasarkan screen)
  let best = null;
  let bestD = 1e9;

  // kita cukup cek semua meteors, tapi ringan karena 43 doang
  for(const m of meteors){
    const p = worldToScreen(m.x,m.y);
    const d = Math.hypot(p.sx - sx, p.sy - sy);
    if(d < bestD){
      bestD = d;
      best = m;
    }
  }
  return (bestD <= TAP_RADIUS) ? best : null;
}

/* =========================
   DRAG + ZOOM
========================= */
let dragging = false;
let lastX=0,lastY=0;

canvas.addEventListener('pointerdown', e=>{
  dragging = true;
  lastX = e.clientX;
  lastY = e.clientY;
});

canvas.addEventListener('pointerup', e=>{
  // tap detect (jika tidak drag jauh)
  const moved = Math.hypot(e.clientX - lastX, e.clientY - lastY);
  dragging = false;

  if(moved < 10){
    const hit = pickMeteorAtScreen(e.clientX, e.clientY);
    if(hit){
      followId = hit.id;
      autoTour = false;
      btnAuto.textContent = `üß≠ Auto Tour: OFF`;
      // zoom sedikit biar kerasa "masuk"
      cam.targetZoom = Math.min(2.4, Math.max(cam.targetZoom, 1.35));
    }else{
      // tap kosong = lepas follow
      followId = null;
    }
  }
});

canvas.addEventListener('pointermove', e=>{
  if(!dragging) return;
  followId = null; // drag manual memutus follow
  autoTour = false;
  btnAuto.textContent = `üß≠ Auto Tour: OFF`;

  const dx = e.clientX - lastX;
  const dy = e.clientY - lastY;
  cam.x -= dx / cam.zoom;
  cam.y -= dy / cam.zoom;
  lastX = e.clientX;
  lastY = e.clientY;
});

canvas.addEventListener('wheel', e=>{
  e.preventDefault();
  followId = null;
  autoTour = false;
  btnAuto.textContent = `üß≠ Auto Tour: OFF`;

  const zoomFactor = (e.deltaY > 0) ? 0.9 : 1.1;
  cam.targetZoom = Math.min(3.0, Math.max(0.55, cam.targetZoom * zoomFactor));
},{passive:false});

// pinch zoom
let lastPinch = null;
canvas.addEventListener('touchmove', e=>{
  if(e.touches.length !== 2) return;
  const dx = e.touches[0].clientX - e.touches[1].clientX;
  const dy = e.touches[0].clientY - e.touches[1].clientY;
  const d = Math.hypot(dx,dy);
  if(lastPinch){
    const ratio = d / lastPinch;
    cam.targetZoom = Math.min(3.0, Math.max(0.55, cam.targetZoom * ratio));
  }
  lastPinch = d;
},{passive:false});
canvas.addEventListener('touchend', ()=> lastPinch=null);

/* =========================
   RECORDING (Canvas + Audio)
   - Output: .webm (tinggal upload/convert ke mp4)
========================= */
let recorder = null;
let chunks = [];
let recording = false;

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

async function setupRecorder(){
  // capture canvas
  const stream = canvas.captureStream(30);

  // mix audio (music) via WebAudio -> MediaStreamDestination
  const ac = new (window.AudioContext || window.webkitAudioContext)();
  const src = ac.createMediaElementSource(music);
  const dest = ac.createMediaStreamDestination();
  src.connect(dest);
  src.connect(ac.destination);

  // add audio tracks to canvas stream
  dest.stream.getAudioTracks().forEach(t => stream.addTrack(t));

  recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
  recorder.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
  recorder.onstop = () => {
    const blob = new Blob(chunks, {type:'video/webm'});
    chunks = [];
    downloadBlob(blob, `nebula-adventure-${Date.now()}.webm`);
  };
}

btnRec.onclick = async ()=>{
  try{
    if(!recording){
      if(!recorder) await setupRecorder();
      recording = true;
      btnRec.textContent = "üé• Record: ON";
      recorder.start(1000);
      // supaya ada audio, pastikan musik main
      if(music.paused) await music.play().catch(()=>{});
    }else{
      recording = false;
      btnRec.textContent = "üé• Record: OFF";
      recorder.stop();
    }
  }catch(e){
    alert("Recorder tidak didukung di browser ini. Coba Chrome Android.");
  }
};

/* =========================
   NEBULA BACKGROUND
========================= */
function drawNebula(){
  // base
  ctx.fillStyle = "#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // soft nebula layers
  const cx = canvas.width/2, cy = canvas.height/2;
  for(let i=0;i<4;i++){
    const r = (Math.max(canvas.width, canvas.height) * (0.45 + i*0.18));
    const g = ctx.createRadialGradient(
      cx + Math.cos(i*1.7)*80,
      cy + Math.sin(i*1.3)*80,
      40,
      cx, cy, r
    );
    g.addColorStop(0, `rgba(${40+i*18}, ${20+i*10}, ${60+i*25}, 0.55)`);
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.fill();
  }

  // stars
  ctx.globalAlpha = 0.75;
  for(let i=0;i<55;i++){
    const x = (i*97 + 123) % canvas.width;
    const y = (i*173 + 77) % canvas.height;
    const s = (i%3)+1;
    ctx.fillStyle = `rgba(255,255,255,${0.15 + (i%5)*0.05})`;
    ctx.fillRect(x,y,s,s);
  }
  ctx.globalAlpha = 1;
}

/* =========================
   RENDER LOGIC (ANTI HILANG)
   - Apparent size & alpha pakai formula halus
   - Render hanya MAX_RENDER meteor terdekat
========================= */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

function apparent(m){
  const dx = m.x - cam.x;
  const dy = m.y - cam.y;
  const d  = Math.hypot(dx,dy);

  // Size halus: makin dekat makin besar, tapi tidak meledak
  const s = (m.size * cam.zoom) / (1 + d/750);

  // Alpha halus: jauh memudar, dekat solid
  // Zoom IN = lebih fokus dekat (tapi tidak bikin dekat hilang)
  const focus = 1400 / cam.zoom; // zoom in -> focus radius mengecil
  const a = clamp(1 - (d / focus), 0, 1);

  return { d, s, a };
}

/* =========================
   ANIMATION LOOP
========================= */
let time = 0;

function step(){
  requestAnimationFrame(step);
  time++;

  // smooth zoom
  cam.zoom = lerp(cam.zoom, cam.targetZoom, 0.12);

  // update orbit (meteor bergerak pelan)
  for(const m of meteors){
    m.baseAngle += ORBIT_SPEED * m.speed;
    const r = m.orbitR;
    m.x = Math.cos(m.baseAngle)*r;
    m.y = Math.sin(m.baseAngle)*r;

    // trail history
    m.trail.push({x:m.x, y:m.y});
    if(m.trail.length > TRAIL_LEN) m.trail.shift();
  }

  // follow logic
  if(followId){
    const m = meteors.find(x=>x.id===followId);
    if(m){
      cam.x = lerp(cam.x, m.x, followStrength);
      cam.y = lerp(cam.y, m.y, followStrength);
      // zoom perlahan untuk ‚Äúmasuk foto‚Äù
      cam.targetZoom = lerp(cam.targetZoom, 2.2, 0.02);
    }
  }

  // auto tour: jalan-jalan ke meteor terdekat berganti-ganti
  if(autoTour){
    const idx = Math.floor((time/240) % meteors.length);
    const m = meteors[idx];
    cam.x = lerp(cam.x, m.x, 0.02);
    cam.y = lerp(cam.y, m.y, 0.02);
    cam.targetZoom = lerp(cam.targetZoom, 1.6 + Math.sin(time/120)*0.15, 0.02);
  }

  // background
  drawNebula();

  // pilih MAX_RENDER meteor terdekat
  const candidates = meteors.map(m=>{
    const ap = apparent(m);
    return { m, ...ap };
  }).sort((a,b)=>a.d-b.d).slice(0, MAX_RENDER);

  // HUD
  hud.textContent = `Loaded: ${loadedCount}/${TOTAL_PHOTO} ‚Ä¢ Render: ${candidates.length}/${MAX_RENDER} ‚Ä¢ Zoom: ${cam.zoom.toFixed(2)} ‚Ä¢ Follow: ${followId ?? '-'} `;

  // draw trails first
  for(const it of candidates){
    const m = it.m;
    const a = it.a;
    if(a <= 0.05 || m.trail.length < 2) continue;

    ctx.save();
    ctx.globalAlpha = 0.35 * a;
    ctx.lineWidth = 2 * cam.zoom;
    ctx.strokeStyle = "rgba(255,255,255,0.65)";
    ctx.beginPath();

    for(let i=0;i<m.trail.length;i++){
      const p = m.trail[i];
      const sx = (p.x - cam.x)*cam.zoom + canvas.width/2;
      const sy = (p.y - cam.y)*cam.zoom + canvas.height/2;
      if(i===0) ctx.moveTo(sx,sy);
      else ctx.lineTo(sx,sy);
    }
    ctx.stroke();
    ctx.restore();
  }

  // draw meteors (photos)
  for(const it of candidates){
    const m = it.m;
    const s = it.s;
    const a = it.a;

    // jangan "ngilang mendadak"
    if(a <= 0.02) continue;
    if(s <= 6) continue; // kecil banget skip (hemat)

    const sx = (m.x - cam.x)*cam.zoom + canvas.width/2;
    const sy = (m.y - cam.y)*cam.zoom + canvas.height/2;

    // depth effect: saat zoom in, objek jauh makin redup dan terasa menjauh
    ctx.save();
    ctx.globalAlpha = a;

    // glow halo
    const halo = ctx.createRadialGradient(sx,sy, s*0.2, sx,sy, s*0.9);
    halo.addColorStop(0, "rgba(255,255,255,0.22)");
    halo.addColorStop(1, "rgba(255,255,255,0.0)");
    ctx.fillStyle = halo;
    ctx.beginPath(); ctx.arc(sx,sy, s*0.9, 0, Math.PI*2); ctx.fill();

    // circle photo
    ctx.beginPath();
    ctx.arc(sx,sy, s/2, 0, Math.PI*2);
    ctx.clip();

    if(m.img.complete && m.img.naturalWidth){
      ctx.drawImage(m.img, sx - s/2, sy - s/2, s, s);
    }else{
      // placeholder loading
      ctx.fillStyle = "rgba(120,120,140,0.35)";
      ctx.fillRect(sx - s/2, sy - s/2, s, s);
    }

    ctx.restore();
  }

  // romantic text when close
  // cari meteor terdekat (yang sedang dilihat)
  const nearest = candidates[0];
  if(nearest){
    const m = nearest.m;
    const closeEnough = nearest.d < (260 / cam.zoom);   // makin zoom in, threshold makin "ketat"
    const zoomEnough  = cam.zoom > 1.6;

    const line = loveLines.get(m.id);
    if(line && closeEnough && zoomEnough){
      loveBox.innerHTML = `${line}<small>(${m.id}.jpg)</small>`;
      loveBox.style.opacity = 1;
    }else{
      loveBox.style.opacity = 0;
    }
  }else{
    loveBox.style.opacity = 0;
  }
}
step();
</script>
</body>
      </html>
